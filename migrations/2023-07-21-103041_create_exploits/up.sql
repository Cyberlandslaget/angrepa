CREATE TABLE service (
    name TEXT PRIMARY KEY
);

CREATE TABLE team (
    ip TEXT PRIMARY KEY,
    name TEXT
);

CREATE TABLE exploit (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    service TEXT NOT NULL,
    blacklist TEXT[] NOT NULL,
    enabled BOOLEAN NOT NULL,
    docker_image TEXT NOT NULL,
    docker_containers TEXT[] NOT NULL,
    pool_size INTEGER NOT NULL,

    FOREIGN KEY (service) REFERENCES service (name)
);

CREATE TABLE target (
    id SERIAL PRIMARY KEY,
    flag_id TEXT NOT NULL,
    service TEXT NOT NULL,
    team TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL,

    FOREIGN KEY (service) REFERENCES service (name),
    FOREIGN KEY (team) REFERENCES team (ip)
);

CREATE TABLE execution (
    id SERIAL PRIMARY KEY,
    exploit_id INTEGER NOT NULL,
    output TEXT NOT NULL,
    started_at TIMESTAMP NOT NULL,
    finished_at TIMESTAMP NOT NULL,
    target_id INTEGER NOT NULL,

    FOREIGN KEY (exploit_id) REFERENCES exploit (id),
    FOREIGN KEY (target_id) REFERENCES target (id)
);

CREATE TABLE flag (
    id SERIAL PRIMARY KEY,
    text TEXT NOT NULL,
    status TEXT NOT NULL,
    submitted BOOLEAN NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    execution_id INTEGER NOT NULL,
    exploit_id INTEGER NOT NULL,

    FOREIGN KEY (execution_id) REFERENCES execution (id),
    FOREIGN KEY (exploit_id) REFERENCES exploit (id)
)
